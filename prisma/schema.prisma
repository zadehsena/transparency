datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  String          @id @default(cuid())
  email               String          @unique
  password            String
  firstName           String?
  lastName            String?
  birthdate           DateTime?
  location            String?
  interests           InterestGroup[]
  level               String?
  onboardingCompleted Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt // <- remove @default(now())
  applications        Application[]
  profile             Profile?
}

model InterestGroup {
  id        String @id @default(cuid())
  userId    String
  category  String
  subtopics Json?
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category]) // prevents duplicates per user/category (optional but handy)
  @@index([userId])
}

model Company {
  id                  String         @id @default(cuid())
  slug                String         @unique
  name                String

  // Transparency / stats
  medianResponseDays  Int?
  overallResponseRate Int?
  totalApplications   Int?

  // Size & basics
  employees Int?
  foundedYear         Int?
  industry            String?

  // Headquarters
  hqCity              String?
  hqCountry           String?

  // Web presence
  website             String?
  domain              String?
  linkedinUrl         String? 
  twitterUrl          String?
  updatedAt           DateTime       @updatedAt

  businessUnits       BusinessUnit[]
  jobs                Job[]
  searchEvents        SearchEvent[]
}

model BusinessUnit {
  id                 String  @id @default(cuid())
  name               String
  applications       Int     @default(0)
  responses          Int     @default(0)
  interviews         Int     @default(0)
  offers             Int     @default(0)
  medianResponseDays Int?
  company            Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId          String
  jobs               Job[]
}

enum JobCategory {
  software
  data_analytics
  product_management
  design
  devops_sre
  security
  qa
  it_support
  marketing
  sales
  operations
  finance
  hr
  legal
  other
}

enum Region {
  north_america
  europe
  asia
  oceania
  latin_america
  middle_east
  africa
  remote
  global
}

model Job {
  id             String        @id @default(cuid())
  title          String
  company        String
  location       String
  source         String?
  url            String?
  ats            String
  externalId     String
  postedAt       DateTime      @default(now())
  closed         Boolean       @default(false)
  closedAt       DateTime?
  companyRel     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId      String
  businessUnit   BusinessUnit? @relation(fields: [businessUnitId], references: [id])
  businessUnitId String?
  applications   Application[]
  category       JobCategory?
  region         Region?
  descriptionHtml String? @db.Text

  @@unique([ats, externalId])
  @@index([companyId, postedAt])
  @@index([category, postedAt])
  @@index([region])
}

model SearchEvent {
  id        String   @id @default(cuid())
  term      String
  slug      String
  companyId String?
  createdAt DateTime @default(now())
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([slug, createdAt])
  @@index([createdAt])
}

model Application {
  id              String            @id @default(cuid())
  userId          String
  jobId           String
  status          ApplicationStatus @default(clicked)
  createdAt       DateTime          @default(now()) // when they clicked Apply
  submittedAt     DateTime?
  updatedAt       DateTime          @updatedAt
  firstResponseAt DateTime?
  user            User              @relation(fields: [userId], references: [id])
  job             Job               @relation(fields: [jobId], references: [id])

  @@unique([userId, jobId])
  @@index([userId, createdAt])
  @@index([status])
}

enum ApplicationStatus {
  clicked    // default, after Apply click
  applied    // user confirmed they submitted
  interview
  offer
  rejected
}

model Profile {
  userId                  String   @id
  phone                   String?
  location                String?
  yearsExperience         Int?
  skills                  Json?
  industries              Json?
  notifications           Json?
  updatedAt               DateTime @updatedAt
  educationSchool         String?
  educationDegree         String?
  educationField          String?
  educationGraduationYear Int?
  currentCompany          String?
  currentTitle            String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  ip        String?
  createdAt DateTime @default(now())
}